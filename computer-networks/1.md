### 一些计算机网络基础

---

TCP/IP模型是互联网的基础，主要是四层模型，链路层、网络层、传输层和应用层。另外有更为详细具体的OSI七层模型，但并没有被广泛采用。

---

#### 链路层

---

数据链路层是一种协议层，它有很多协议。数据链路层**用于跨物理层在网段节点之间传输数据**，通常指以太网、无线局域网等通信手段。数据链路层提供了在网络的两个实体之间传输数据的功能。

- 以太网和802.3封装 ：

  以太网IP数据报的封装是在RFC894中定义的，IEEE802.3网络的IP数据报封装是在RFC1042中定义的。

  两种协议的头部都为mac地址，对于ip报文段，IEEE802.3封装中，采用了LLC (逻辑链路控制, 链路上层协议, 为不同的网络类型, 以太网，令牌环网等之间提供了一个通用的接口) , SNAP (子网络访问协议)的格式，以太网则是ARP/RARP（地址解析协议 : 通过IP地址获得对应的MAC地址/反向地址转换协议 : 相反)。

  LLC只出现在802.3的格式中，802.3的MAC层没有字段指明上层协议字段，但是指明了数据包长度，所以上层协议需要LLC指明。

  在ETHERNET_II帧中，把802.3的长度字段改为了type。由Type字段区分上层协议，这时候就没有必要实现LLC子层，仅包含一个MAC子层。

- ARP协议:

  在以太网中，一个主机要和另一个主机进行直接通信，必须要知道目标主机的MAC地址, ARP协议的基本功能就是通过目标设备的IP地址，查询目标设备的MAC地址，以保证通信的顺利进行。

- ARP缓存: 

  缓存最近的mac地址和ip的映射

  linux操作系统中可用 arp -a 命令来查看

- SLIP协议和PPP协议 ：

  SLIP : 串行线路网际协议, 拨号上网的基础 / PPP : 可以看作SLIP的升级, 点对点模式，由LCP( 负责设备之间**链路的创建、维护和终止**), NCP (动态ip协商等功能), PPP扩展三部分协议组成. 

- 环回接口：

  常见的127.0.0.1,作为localhost ,比较常见无需多说.

- MTU :

  数据包的最大传输单元

---

#### 网络层 (IP协议)

---

IP是TCP/IP中最为核心的协议，所有的TCP、UDP、ICMP等协议均以IP数据报的格式传输。IP协议提供不可靠、无连接的服务，它不保证数据报一定可以送达目的，也不保证数据报的先后次序。

![image-20220524233122879](./image/ip.png)

- **版本** : IP报文版本号 IPV4:4, IPV6:6 
- **首部长度** : IP 头部信息长度，没有选项，则一般为5（5x32bit＝20B）
- **TOS** : 可以指定更细节的服务类别，如最小延迟，最大吞吐量，最高可靠性等
- **16位置总长度 **: header＋数据 总长度
- **16位标识** : IP 报文的唯一id，分片报文的id 相同，便于进行重组。
- **3位标志** : 标明是否分片。
- **片偏移** : 记录分片偏移的位置
- **TTL** : 生存时间，即路由器的跳数，每经过一个路由器，该TTL 减一
- **8位协议**  qq: 区分传输层的协议，如 TCP:6，UDP:17
- **首部校验和** : IP header校验和

---

#### 一些概念

- LAN端口：路由器上链接局域网(自己设备)的端口

- WAN端口 : 路由器上链接到外部网关，或者别的网络的端口

- NAT协议 : 内外网地址转换的协议，可以穿透内外网，实现局域网访问公网ip (要实现跨外网的局域网通讯，可以使用一台有公网ip的服务器作为转发)。原理为在网关为不同的子网ip分配不同的映射端口并且记录。

- 几类地址：

  - A类：地址范围1.0.0.1-126.255.255.255，A类IP地址的子网掩码为255.0.0.0，每个网络支持的最大主机数为256的3次方-2=16777214台。
  - B类：地址范围128.0.0.1-191.255.255.255，B类IP地址的子网掩码为255.255.0.0，每个网络支持的最大主机数为256的2次方-2=65534台
  - C类：地址范围192.0.1.1-223.255.255.255，C类IP地址的子网掩码为255.255.255.0，每个网络支持的最大主机数为256-2=254台
  - D类：以1110开始的地址，多播地址
  - E类：以11110开始的地址，保留地址

  其实这些地址只是历史遗留概念，现在很少再做区分，注意局域网地址和c类地址的概念，由于他们都是以192.***的格式，让我曾经误认为c类地址就是为局域网采用的格式，其实并不是，只不过在局域网中需要的机器数量不多，c类地址已能够支撑，其实ABC三类地址都可以作为局域网地址。

  同时192开头的地址也有公网地址，被lsp发行和维护，两者之间并没有什么绝对关联。

- ICMP : 

  ICMP报文是在IP数据报内部传输的：`| IP头部 | ICMP报文 |`

  可以反映通讯的信息，比如网络/端口是否可达，错误类型等

----

#### 路由

---

路由表 

```sh
# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.0.0      0.0.0.0         255.255.192.0   U     0      0        0 eth0
0.0.0.0         192.168.0.1      0.0.0.0         UG    100    0        0 eth0
```

Destination/Genmask : 目标地址和掩码 0.0.0.0为默认网关

Gateway : 下一跳，0.0.0.0说明为直连，不需要网关

Flags :

- U 该路由可用
- G 该路由发送到网关，没有则为直接链接
- H 说明目标是个独立主机，没有则为一个网络

可以使用route命令来修改路由表，同时ICMP在ip报文交换时也会更新路由表。